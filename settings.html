<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gengo 設定</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- i18next -->
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="i18n.js"></script>
    <style>
        .full-container {
            margin: 0;
            padding: 20px;
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
            background: white;
            overflow-y: scroll;
            /* スクロールバーを常に表示 */
        }

        /* スクロールバーのスタイリング（Webkit系ブラウザ用） */
        .full-container::-webkit-scrollbar {
            width: 12px;
        }

        .full-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .full-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }

        .full-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>
    <div class="full-container">
        <div class="card h-100 border-0">
            <div class="card-title d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="settings-title">
                    <i class="bi bi-gear"></i> <span id="settingsTitle">設定</span>
                </h5>
                <button type="button" class="btn btn-light btn-sm" id="closeBtn">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <!-- UI言語設定 -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-globe"></i> <span id="ui-language-title">UI言語</span>
                            </h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <label for="uiLanguage" class="form-label" id="ui-language-label">UI言語</label>
                                    <select class="form-select" id="uiLanguage">
                                        <option value="ja">日本語</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- プロンプト設定 -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3" id="prompt-section-title">
                                <i class="bi bi-chat-left-text"></i> プロンプト設定
                            </h6>

                            <div class="mb-3">
                                <label for="customPrompt" class="form-label" id="prompt-label">事前プロンプト</label>
                                <textarea class="form-control" id="customPrompt" rows="4"
                                    placeholder="日本語と英語を相互翻訳してください。入力されたテキストの言語を自動判定して、もう一方の言語に翻訳してください。"></textarea>
                                <small class="text-muted" id="prompt-description">
                                    事前プロンプトショートカットで実行されるプロンプトです。デフォルトは日本語と英語の相互翻訳です。
                                </small>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="resetPromptBtn">
                                        <i class="bi bi-arrow-clockwise"></i> <span
                                            id="reset-prompt-btn-text">デフォルトに戻す</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ショートカットキー設定 -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3" id="shortcuts-title">
                                <i class="bi bi-keyboard"></i> ショートカットキー
                            </h6>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="shortcutKey" class="form-label"
                                        id="shortcut-label">事前プロンプトショートカット</label>
                                    <input type="text" class="form-control" id="shortcutKey" placeholder="Ctrl+1"
                                        value="Ctrl+1">
                                </div>
                                <div class="col-md-6">
                                    <div class="form-control-plaintext text-muted small">
                                        <div id="shortcut-desc-label" class="small fw-bold mb-1"></div>
                                        <div id="shortcut-description"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="onDemandShortcutKey" class="form-label"
                                        id="ondemand-shortcut-label">オンデマンドプロンプトショートカット</label>
                                    <input type="text" class="form-control" id="onDemandShortcutKey"
                                        placeholder="Ctrl+2" value="Ctrl+2">
                                </div>
                                <div class="col-md-6">
                                    <div class="form-control-plaintext text-muted small">
                                        <div id="ondemand-shortcut-desc-label" class="small fw-bold mb-1"></div>
                                        <div id="ondemand-shortcut-description"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- ショートカットキー記法説明 -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading mb-2" id="shortcut-notation-title">
                                            <i class="bi bi-info-circle"></i> 利用可能なショートカット記号の説明
                                        </h6>
                                        <div id="shortcut-notation-content"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LLMエンジン設定 -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3" id="llm-settings-title">
                                <i class="bi bi-cpu"></i> LLMエンジン設定
                            </h6>

                            <!-- LLMプロバイダー選択 -->
                            <div class="mb-3">
                                <label for="llmProvider" class="form-label" id="llm-provider-label">LLMプロバイダー</label>
                                <select class="form-select" id="llmProvider">
                                    <option value="local" id="llm-provider-local-option">ローカルLLM</option>
                                    <option value="remote" id="llm-provider-remote-option">リモートLLM</option>
                                </select>
                            </div>

                            <!-- エンドポイントURL（共通） -->
                            <div class="mb-3">
                                <label for="llmEndpoint" class="form-label" id="llm-endpoint-label">APIエンドポイント</label>
                                <input type="text" class="form-control" id="llmEndpoint"
                                    placeholder="http://127.0.0.1:1234/v1">
                                <small class="text-muted" id="llm-endpoint-description">
                                    ベースURL（例: http://127.0.0.1:1234/v1 または https://api.openai.com/v1）。/chat/completions
                                    は自動で追加されます
                                </small>
                            </div>

                            <!-- リモート接続用設定 -->
                            <div id="remoteSettings" style="display: none;">
                                <div class="mb-3">
                                    <label for="apiKey" class="form-label" id="api-key-label">APIキー</label>
                                    <input type="password" class="form-control" id="apiKey"
                                        placeholder="your-api-key-here">
                                    <small class="text-muted" id="api-key-description">
                                        リモートLLMサービスのAPIキー（ローカルに保存されます）
                                    </small>
                                </div>

                                <div class="mb-3">
                                    <label for="modelName" class="form-label" id="model-name-label">モデル名</label>
                                    <input type="text" class="form-control" id="modelName" placeholder="gpt-4o-mini">
                                    <small class="text-muted" id="model-name-description">
                                        使用するモデル名（例: gpt-4o-mini, gpt-4, claude-3-5-sonnet-20241022）
                                    </small>
                                </div>
                            </div>

                            <!-- 最大トークン数設定 -->
                            <div class="mb-3">
                                <label for="maxTokens" class="form-label" id="max-tokens-label">最大トークン数</label>
                                <input type="number" class="form-control" id="maxTokens" placeholder="4096" min="256"
                                    max="32768" step="256">
                                <small class="text-muted" id="max-tokens-description">
                                    LLMの応答に使用する最大トークン数（デフォルト: 4096）
                                </small>
                            </div>

                            <!-- LLM接続テストボタン -->
                            <button type="button" class="btn btn-outline-primary btn-sm" id="testLLMConnection">
                                <i class="bi bi-wifi"></i> <span id="test-connection-text">接続テスト</span>
                            </button>
                            <div id="llmTestResult" class="mt-2"></div>
                        </div>

                        <!-- その他の設定 -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3" id="other-settings-title">
                                <i class="bi bi-toggles"></i> その他の設定
                            </h6>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="autoApplyAndClose">
                                <label class="form-check-label" for="autoApplyAndClose" id="auto-apply-and-close-label">
                                    AI処理完了後に自動で結果を適用してウィンドウを閉じる
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-danger" id="resetBtn">
                        <i class="bi bi-arrow-clockwise"></i> リセット
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">
                            キャンセル
                        </button>
                        <button type="button" class="btn btn-dark" id="saveBtn">
                            <i class="bi bi-check"></i> 保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            // 翻訳を読み込み
            await loadTranslations();

            // 設定を読み込み
            await loadSettings();

            // イベントリスナー設定
            document.getElementById('closeBtn').addEventListener('click', closeWindow);
            document.getElementById('cancelBtn').addEventListener('click', closeWindow);
            document.getElementById('saveBtn').addEventListener('click', saveSettings);
            document.getElementById('resetBtn').addEventListener('click', resetSettings);

            // UI言語変更イベント
            document.getElementById('uiLanguage').addEventListener('change', async (e) => {
                await changeUILanguage(e.target.value);
            });

            // プロンプトリセットボタンイベント
            document.getElementById('resetPromptBtn').addEventListener('click', resetPrompt);

            // LLMプロバイダー変更イベント
            document.getElementById('llmProvider').addEventListener('change', handleProviderChange);

            // LLM接続テストイベント
            document.getElementById('testLLMConnection').addEventListener('click', testLLMConnection);
        });

        // 翻訳を読み込み
        async function loadTranslations() {
            try {
                const currentLang = await window.electronAPI.getCurrentLanguage();
                document.getElementById('uiLanguage').value = currentLang;
                await updateUITexts();
                await populateLanguageOptions();
            } catch (error) {
                console.error('翻訳読み込みエラー:', error);
            }
        }

        // UI言語を変更
        async function changeUILanguage(language) {
            try {
                const currentLang = await window.electronAPI.getCurrentLanguage();

                // 言語が実際に変更された場合のみダイアログを表示
                if (language !== currentLang) {
                    // 再起動ダイアログのメッセージを取得
                    const title = await window.electronAPI.getTranslation('settings.ui_language.restart_dialog.title');
                    const message = await window.electronAPI.getTranslation('settings.ui_language.restart_dialog.message');

                    // ダイアログで確認
                    if (confirm(`${title}\n\n${message}`)) {
                        // まず言語設定を保存
                        await window.electronAPI.changeLanguage(language);

                        // アプリケーションを再起動
                        await window.electronAPI.restartApp();
                    } else {
                        // キャンセルされた場合は元の言語に戻す
                        document.getElementById('uiLanguage').value = currentLang;
                    }
                } else {
                    // 同じ言語の場合はUIを更新するだけ
                    await updateUITexts();
                    await populateLanguageOptions();
                }
            } catch (error) {
                console.error('言語変更エラー:', error);
            }
        }

        // UIテキストを更新
        async function updateUITexts() {
            try {
                // ヘッダー
                document.getElementById('settings-title').innerHTML =
                    '<i class="bi bi-gear"></i> ' + await window.electronAPI.getTranslation('settings.title');

                // UI言語セクション
                document.getElementById('ui-language-title').textContent =
                    await window.electronAPI.getTranslation('settings.ui_language.title') || 'UI言語';
                document.getElementById('ui-language-label').textContent =
                    await window.electronAPI.getTranslation('settings.ui_language.label') || 'UI言語';

                // プロンプト設定セクション
                document.getElementById('prompt-section-title').innerHTML =
                    '<i class="bi bi-chat-left-text"></i> ' + await window.electronAPI.getTranslation('settings.prompt.title');
                document.getElementById('prompt-label').textContent =
                    await window.electronAPI.getTranslation('settings.prompt.preset_label');
                document.getElementById('prompt-description').textContent =
                    await window.electronAPI.getTranslation('settings.prompt.preset_description');
                document.getElementById('reset-prompt-btn-text').textContent =
                    await window.electronAPI.getTranslation('settings.prompt.reset_button');

                // ショートカットセクション
                document.getElementById('shortcuts-title').innerHTML =
                    '<i class="bi bi-keyboard"></i> ' + await window.electronAPI.getTranslation('settings.shortcuts.title');
                document.getElementById('shortcut-label').textContent =
                    await window.electronAPI.getTranslation('settings.shortcuts.preset_prompt_shortcut');
                document.getElementById('ondemand-shortcut-label').textContent =
                    await window.electronAPI.getTranslation('settings.shortcuts.ondemand_shortcut');
                document.getElementById('shortcut-desc-label').textContent =
                    await window.electronAPI.getTranslation('settings.shortcuts.description_label') || '説明';
                document.getElementById('ondemand-shortcut-desc-label').textContent =
                    await window.electronAPI.getTranslation('settings.shortcuts.ondemand_description_label') || '説明';
                document.getElementById('shortcut-description').textContent =
                    await window.electronAPI.getTranslation('settings.shortcuts.preset_description') || '';
                document.getElementById('ondemand-shortcut-description').textContent =
                    await window.electronAPI.getTranslation('settings.shortcuts.ondemand_description') || '';
                document.getElementById('shortcut-notation-title').innerHTML =
                    '<i class="bi bi-info-circle"></i> ' + await window.electronAPI.getTranslation('settings.shortcuts.notation_title');
                document.getElementById('shortcut-notation-content').innerHTML =
                    await window.electronAPI.getTranslation('settings.shortcuts.available_keys_html') || '';

                // LLMエンドポイント設定セクション
                document.getElementById('llm-settings-title').innerHTML =
                    '<i class="bi bi-cpu"></i> ' + await window.electronAPI.getTranslation('settings.llm.title');

                // LLMプロバイダー関連
                document.getElementById('llm-provider-label').textContent =
                    await window.electronAPI.getTranslation('settings.llm.provider');
                document.getElementById('llm-provider-local-option').textContent =
                    await window.electronAPI.getTranslation('settings.llm.provider_local');
                document.getElementById('llm-provider-remote-option').textContent =
                    await window.electronAPI.getTranslation('settings.llm.provider_remote');

                // エンドポイント関連
                document.getElementById('llm-endpoint-label').textContent =
                    await window.electronAPI.getTranslation('settings.llm.endpoint');
                document.getElementById('llm-endpoint-description').textContent =
                    await window.electronAPI.getTranslation('settings.llm.endpoint_description');

                // APIキー関連
                document.getElementById('api-key-label').textContent =
                    await window.electronAPI.getTranslation('settings.llm.api_key');
                document.getElementById('api-key-description').textContent =
                    await window.electronAPI.getTranslation('settings.llm.api_key_description');

                // モデル名関連
                document.getElementById('model-name-label').textContent =
                    await window.electronAPI.getTranslation('settings.llm.model_name');
                document.getElementById('model-name-description').textContent =
                    await window.electronAPI.getTranslation('settings.llm.model_name_description');

                // 最大トークン数関連
                document.getElementById('max-tokens-label').textContent =
                    await window.electronAPI.getTranslation('settings.llm.max_tokens');
                document.getElementById('max-tokens-description').textContent =
                    await window.electronAPI.getTranslation('settings.llm.max_tokens_description');

                // 接続テスト
                document.getElementById('test-connection-text').textContent =
                    await window.electronAPI.getTranslation('settings.llm.test_connection');

                // その他設定セクション
                document.getElementById('other-settings-title').innerHTML =
                    '<i class="bi bi-toggles"></i> ' + await window.electronAPI.getTranslation('settings.other.title');
                document.getElementById('auto-apply-and-close-label').textContent =
                    await window.electronAPI.getTranslation('settings.other.auto_apply_and_close');

                // ボタン
                document.getElementById('saveBtn').innerHTML =
                    '<i class="bi bi-check"></i> ' + await window.electronAPI.getTranslation('settings.buttons.save');
                document.getElementById('cancelBtn').textContent =
                    await window.electronAPI.getTranslation('settings.buttons.cancel');
                document.getElementById('resetBtn').innerHTML =
                    '<i class="bi bi-arrow-clockwise"></i> ' + await window.electronAPI.getTranslation('settings.buttons.reset');

            } catch (error) {
                console.error('UIテキスト更新エラー:', error);
            }
        }

        // 言語選択肢を動的に作成
        async function populateLanguageOptions() {
            try {
                const languages = [
                    'ja', 'en', 'zh', 'ko', 'fr', 'de', 'es', 'it', 'pt', 'ru'
                ];

                const language1Select = document.getElementById('language1');
                const language2Select = document.getElementById('language2');

                // 既存の選択肢をクリア
                language1Select.innerHTML = '';
                language2Select.innerHTML = '';

                // 各言語の選択肢を作成
                for (const langCode of languages) {
                    const langName = await window.electronAPI.getTranslation(`languages.${langCode}`);
                    console.log(`言語コード: ${langCode}, 取得した言語名: ${langName}`);

                    // Language1用のオプション
                    const option1 = document.createElement('option');
                    option1.value = langCode;
                    option1.textContent = langName;
                    language1Select.appendChild(option1);

                    // Language2用のオプション
                    const option2 = document.createElement('option');
                    option2.value = langCode;
                    option2.textContent = langName;
                    language2Select.appendChild(option2);
                }

                // 作成されたオプションを確認
                console.log('Language1 オプション一覧:');
                for (const option of language1Select.options) {
                    console.log(`  value: ${option.value}, text: ${option.textContent}`);
                }
                console.log('Language2 オプション一覧:');
                for (const option of language2Select.options) {
                    console.log(`  value: ${option.value}, text: ${option.textContent}`);
                }
            } catch (error) {
                console.error('言語選択肢作成エラー:', error);
            }
        }

        // 設定読み込み
        async function loadSettings() {
            try {
                const settings = await window.electronAPI.getSettings();

                // 最初に言語選択肢を作成
                await populateLanguageOptions();

                // UI言語設定を含める
                if (settings.language) {
                    document.getElementById('uiLanguage').value = settings.language || 'ja';
                }

                // ショートカットキー設定
                if (settings.shortcutKey) {
                    document.getElementById('shortcutKey').value = settings.shortcutKey;
                }

                // オンデマンドプロンプトショートカット設定
                if (settings.onDemandShortcutKey) {
                    document.getElementById('onDemandShortcutKey').value = settings.onDemandShortcutKey;
                }

                // LLM設定
                document.getElementById('llmProvider').value = settings.llmProvider || 'local';
                document.getElementById('llmEndpoint').value = settings.llmEndpoint || 'http://127.0.0.1:1234/v1';

                if (settings.apiKey) {
                    document.getElementById('apiKey').value = settings.apiKey;
                }

                if (settings.modelName) {
                    document.getElementById('modelName').value = settings.modelName;
                }

                // 最大トークン数設定
                document.getElementById('maxTokens').value = settings.maxTokens || 4096;

                // プロバイダー設定に応じてUI表示を切り替え
                handleProviderChange();

                // プロンプト設定
                if (settings.customPrompt) {
                    document.getElementById('customPrompt').value = settings.customPrompt;
                }

                // 統合された自動適用・閉じる設定
                document.getElementById('autoApplyAndClose').checked = settings.autoApplyAndClose || false;

            } catch (error) {
                console.error('設定読み込みエラー:', error);
            }
        }

        // 設定保存
        async function saveSettings() {
            try {
                const shortcutKey = document.getElementById('shortcutKey').value;
                const onDemandShortcutKey = document.getElementById('onDemandShortcutKey').value;

                // ショートカットキーの検証
                if (shortcutKey && !(await window.electronAPI.validateShortcutKey(shortcutKey))) {
                    const errorMessage = await window.electronAPI.getTranslation('settings.shortcuts.validation_error');
                    showMessage(errorMessage, 'error');
                    return;
                }

                // オンデマンドショートカットキーの検証
                if (onDemandShortcutKey && !(await window.electronAPI.validateShortcutKey(onDemandShortcutKey))) {
                    const errorMessage = await window.electronAPI.getTranslation('settings.shortcuts.validation_error');
                    showMessage(errorMessage, 'error');
                    return;
                }

                const settings = {
                    autoApplyAndClose: document.getElementById('autoApplyAndClose').checked,
                    language: document.getElementById('uiLanguage').value,
                    shortcutKey: shortcutKey,
                    onDemandShortcutKey: onDemandShortcutKey,
                    llmProvider: document.getElementById('llmProvider').value,
                    llmEndpoint: document.getElementById('llmEndpoint').value,
                    apiKey: document.getElementById('apiKey').value,
                    modelName: document.getElementById('modelName').value,
                    maxTokens: parseInt(document.getElementById('maxTokens').value) || 4096,
                    customPrompt: document.getElementById('customPrompt').value
                };

                await window.electronAPI.saveSettings(settings);

                // 保存完了メッセージ
                const successMessage = await window.electronAPI.getTranslation('settings.messages.save_success');
                showMessage(successMessage, 'success');

                setTimeout(() => {
                    closeWindow();
                }, 1000);

            } catch (error) {
                console.error('設定保存エラー:', error);
                const errorMessage = await window.electronAPI.getTranslation('settings.messages.save_error');
                showMessage(errorMessage, 'error');
            }
        }

        // 設定をリセット
        async function resetSettings() {
            try {
                console.log('リセット開始...');

                // 確認ダイアログを表示（UI言語に従う）
                const confirmMessage = await window.electronAPI.getTranslation('settings.messages.reset_confirm');

                if (!confirm(confirmMessage)) {
                    console.log('リセットがキャンセルされました');
                    return;
                }

                console.log('設定をリセット中...');
                // 設定をリセット
                const resetSettingsData = await window.electronAPI.resetSettings();
                console.log('リセット完了、データ:', resetSettingsData);

                if (!resetSettingsData) {
                    throw new Error('リセットデータが受信されませんでした');
                }

                // 要素を取得
                const elements = {
                    autoApplyAndClose: document.getElementById('autoApplyAndClose'),
                    uiLanguage: document.getElementById('uiLanguage'),
                    shortcutKey: document.getElementById('shortcutKey'),
                    onDemandShortcutKey: document.getElementById('onDemandShortcutKey'),
                    llmEndpoint: document.getElementById('llmEndpoint'),
                    customPrompt: document.getElementById('customPrompt')
                };

                // 要素の存在確認
                for (const [key, element] of Object.entries(elements)) {
                    if (!element) {
                        throw new Error(`要素が見つかりません: ${key}`);
                    }
                }

                // 値を設定
                elements.autoApplyAndClose.checked = resetSettingsData.autoApplyAndClose;
                elements.uiLanguage.value = resetSettingsData.language;
                elements.shortcutKey.value = resetSettingsData.shortcutKey;
                elements.onDemandShortcutKey.value = resetSettingsData.onDemandShortcutKey;
                elements.llmEndpoint.value = resetSettingsData.llmEndpoint;
                elements.customPrompt.value = resetSettingsData.customPrompt;

                console.log('フォーム更新完了');

                // UI言語が変更されている可能性があるので翻訳を再読み込み
                console.log('翻訳再読み込み中...');
                await loadTranslations();
                console.log('翻訳再読み込み完了');

                // リセット完了メッセージ
                const successMessage = await window.electronAPI.getTranslation('settings.messages.reset_success');
                showMessage(successMessage, 'success');
                console.log('リセット処理完全に完了');

            } catch (error) {
                console.error('設定リセットエラー:', error);
                console.error('エラースタック:', error.stack);
                try {
                    const errorMessage = await window.electronAPI.getTranslation('settings.messages.reset_error');
                    showMessage(`${errorMessage}: ${error.message}`, 'error');
                } catch (translationError) {
                    // 翻訳取得に失敗した場合のフォールバック
                    showMessage(`設定のリセット中にエラーが発生しました: ${error.message}`, 'error');
                }
            }
        }

        // プロンプトをデフォルトに戻す
        async function resetPrompt() {
            try {
                const defaultPrompt = await window.electronAPI.getDefaultPrompt();
                document.getElementById('customPrompt').value = defaultPrompt;

                const successMessage = await window.electronAPI.getTranslation('settings.prompt.reset_success') || 'プロンプトをデフォルト値に戻しました';
                showMessage(successMessage, 'success');
            } catch (error) {
                console.error('プロンプトリセットエラー:', error);
                const errorMessage = await window.electronAPI.getTranslation('settings.prompt.reset_error') || 'プロンプトのリセット中にエラーが発生しました';
                showMessage(errorMessage, 'error');
            }
        }

        // LLMプロバイダー変更時の処理
        async function handleProviderChange() {
            const provider = document.getElementById('llmProvider').value;
            const remoteSettings = document.getElementById('remoteSettings');
            const endpointInput = document.getElementById('llmEndpoint');
            const endpointDescription = document.getElementById('llm-endpoint-description');

            if (provider === 'remote') {
                remoteSettings.style.display = 'block';
                endpointInput.placeholder = 'https://api.openai.com/v1';
                try {
                    const description = await window.electronAPI.getTranslation('settings.llm.endpoint_description');
                    endpointDescription.textContent = description || 'ベースURL（例: https://api.openai.com/v1）。/chat/completions は自動で追加されます';
                } catch (error) {
                    endpointDescription.textContent = 'ベースURL（例: https://api.openai.com/v1）。/chat/completions は自動で追加されます';
                }
            } else {
                remoteSettings.style.display = 'none';
                endpointInput.placeholder = 'http://127.0.0.1:1234/v1';
                try {
                    const description = await window.electronAPI.getTranslation('settings.llm.endpoint_description');
                    endpointDescription.textContent = description || 'ベースURL（例: http://127.0.0.1:1234/v1）。/chat/completions は自動で追加されます';
                } catch (error) {
                    endpointDescription.textContent = 'ベースURL（例: http://127.0.0.1:1234/v1）。/chat/completions は自動で追加されます';
                }
            }
        }

        // LLM接続テスト
        async function testLLMConnection() {
            const button = document.getElementById('testLLMConnection');
            const resultDiv = document.getElementById('llmTestResult');
            const testText = document.getElementById('test-connection-text');

            // テスト中の表示
            button.disabled = true;
            testText.textContent = 'テスト中...';
            resultDiv.innerHTML = '';

            try {
                const provider = document.getElementById('llmProvider').value;
                const config = {
                    provider: provider,
                    endpoint: document.getElementById('llmEndpoint').value,
                    apiKey: provider === 'remote' ? document.getElementById('apiKey').value : '',
                    modelName: provider === 'remote' ? document.getElementById('modelName').value : 'local-model',
                    maxTokens: parseInt(document.getElementById('maxTokens').value) || 4096
                };

                const result = await window.electronAPI.testLLMConnection(config);

                if (result.success) {
                    const successMessage = await window.electronAPI.getTranslation('settings.llm.test_success') || '接続に成功しました';
                    resultDiv.innerHTML = `<div class="alert alert-success alert-sm">✓ ${successMessage}</div>`;
                } else {
                    const failMessage = await window.electronAPI.getTranslation('settings.llm.test_failed') || '接続に失敗しました';
                    resultDiv.innerHTML = `<div class="alert alert-danger alert-sm">✗ ${failMessage.replace('{{error}}', result.error)}</div>`;
                }
            } catch (error) {
                const failMessage = await window.electronAPI.getTranslation('settings.llm.test_failed') || '接続に失敗しました';
                resultDiv.innerHTML = `<div class="alert alert-danger alert-sm">✗ ${failMessage.replace('{{error}}', error.message)}</div>`;
            } finally {
                button.disabled = false;
                const testButtonText = await window.electronAPI.getTranslation('settings.llm.test_connection') || '接続テスト';
                testText.textContent = testButtonText;

                // 5秒後にメッセージを消去
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 5000);
            }
        }

        // ウィンドウを閉じる
        function closeWindow() {
            window.electronAPI.closeSettingsWindow();
        }

        // メッセージ表示
        function showMessage(message, type = 'info') {
            const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
            const alertElement = document.createElement('div');
            alertElement.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            alertElement.style.top = '20px';
            alertElement.style.right = '20px';
            alertElement.style.zIndex = '9999';
            alertElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertElement);
            setTimeout(() => alertElement.remove(), 3000);
        }
    </script>
</body>

</html>